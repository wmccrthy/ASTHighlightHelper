name: Release AST Inspector VSIX

on:
    push:
        branches:
            - main

jobs:
    release:
        runs-on: [self-hosted, ubuntu-latest]
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Install dependencies
              run: npm install
            
            - name: Build
              run: npm run compile

            - name: Package
              run: npm run package

            - name: Bump Version
              run: npm version patch # TODO: make this configurable/require changelogs w/ patch/minor/major in PRs so we can bump accordingly
            
            - name: Get version
              id: get-version
              run: |
                VERSION=$(cat package.json | jq -r '.version')
                echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
            
            - name: Create release
              id: create-release
              uses: actions/create-release@v1
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                tag_name: ${{ steps.get-version.outputs.VERSION }}
                release_name: Release ${{ steps.get-version.outputs.VERSION }}
                draft: false
                prerelease: true

            - name: Upload VSIX
              uses: actions/upload-release-asset@v1
              with:
                upload_url: ${{ steps.create-release.outputs.upload_url }}
                asset_path: ./ast-inspector-*.vsix
                asset_name: ast-inspector-${{ steps.get-version.outputs.VERSION }}.vsix
                asset_content_type: application/zip